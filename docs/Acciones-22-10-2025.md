Sesion: 22-10-2025
Problema:
1. Corregir el componente/layout que renderiza el saludo "Bienvenido, " sin el nombre del usuario (ver sección Bugs abajo). Asegurar que se le pase `user.displayName` o equivalente.

Solución:
- Saludo "Bienvenido, " no muestra el nombre del usuario en una parte de la aplicación (ver reproducción abajo). Posible causa: componente recibe un objeto `user` distinto (o nulo) que no contiene `name`/`displayName`, o el prop no es pasado desde el layout/autenticación.
  - Reproducción:
    1. Iniciar sesión con usuario: `estudiante1 / demo123`.
    2. Navegar a la página principal del estudiante.
    3. Observar que el saludo superior muestra "Bienvenido, " sin nombre en el header/Welcome card, aunque en otras partes sí aparece el nombre.
  - Pasos sugeridos para arreglar:
    - Localizar el componente que renderiza el saludo (buscar en `components/` por "Bienvenido" o por el fragmento del markup).
    - Verificar qué `user` (o `session`) está siendo usado. Confirmar que el `user` tiene la propiedad `name`, `fullName` o `displayName` que debería mostrarse.
    - Asegurarse de que el componente padre (layout o provider) pasa correctamente el usuario autenticado como prop o que el hook (`useAuth` / `authService`) lo expone en el mismo shape en todas las ubicaciones.
    - Añadir una comprobación defensiva en el render: `Bienvenido, {user?.name ?? user?.displayName ?? 'Estudiante'}`.
    Problema:
    Eliminar logs temporales y el modo `?debug=1` en `pages/api/student/secure-data.ts`.

Acciones realizadas (23-10-2025):

- `pages/api/student/secure-data.ts`:
  - Eliminados los `console.debug` y la rama `?debug=1` que devolvía datos crudos. Se mantuvo la lógica principal de consulta y normalización (`subjects[]`, `grades[]`, `average`, `messages`, `exportLinks`).

- `pages/api/auth/login.ts`:
  - La respuesta JSON de login ahora incluye `firstName`, `lastName`, `displayName` y `email` (además de `username`, `id`, `role`, `token`). Esto permite que el cliente muestre el nombre real del usuario en la UI tras el login.

- `app/student/page.tsx`:
  - Añadida función defensiva `resolveDisplayName(user)` y usado en el saludo: `Bienvenido, {resolveDisplayName(user)}`. El fallback considera `firstName+lastName`, `displayName`, `username`, la parte local del `email` o "Estudiante".

- `components/dashboard-layout.tsx`:
  - Actualizado el menú de usuario para mostrar un nombre con la misma lógica de fallback (first/last, displayName, username, email local-part).

- `lib/middleware/auth.ts`:
  - Modificado `withAuth` para aceptar el token desde la cookie HttpOnly `academic_auth_token` cuando no exista el header `Authorization`. Se intenta leer `req.cookies` y, si no está disponible, se parsea `req.headers.cookie` como fallback. La verificación JWT y el flujo de fallback con `supabaseAdmin.auth.getUser` se mantienen.

Estado y verificación:

- Se compiló el proyecto tras cada cambio (`npm run build`) y la compilación final fue exitosa.
- Prueba manual recomendada:
  1. Levantar servidor dev: `npm run dev`.
  2. Iniciar sesión con `estudiante1 / demo123`.
  3. Verificar en `/student` que el saludo muestre el nombre correcto (o un fallback razonable).
  4. Comprobar en las DevTools > Network que las peticiones a `/api/student/secure-data` son autenticadas mediante la cookie HttpOnly sin necesidad de enviar `Authorization`.

Notas y próximos pasos:

- Seguridad: por ahora el login sigue devolviendo `token` en el cuerpo para compatibilidad; se recomienda eliminar esa práctica y depender sólo de la cookie HttpOnly en próximas tareas.
- Recomendado: refactorizar el cliente para dejar de persistir el token en `localStorage` y confiar en la cookie HttpOnly para peticiones autenticadas.
- Pendiente: verificar exhaustivamente la vista "Mis Calificaciones" (tarea ya en la lista) — comprobar que muestra nombre de evaluación, puntuación, fecha, comentario y que el promedio mostrado corresponde a la materia seleccionada.

Si quieres, puedo encargarme ahora de la verificación completa de "Mis Calificaciones" o de refactorizar el cliente para eliminar el guardado del token en `localStorage`.